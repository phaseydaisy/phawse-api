<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phawse API Studio</title>
  <style>
    :root {
      --bg: #0e0f11;
      --bg-soft: #141518;
      --panel: #1a1b1f;
      --panel-2: #202228;
      --line: #2a2d33;
      --text: #f2f3f5;
      --muted: #b5bac1;
      --accent: #dbdee1;
      --ok: #3ba55c;
      --warn: #faa81a;
      --danger: #ed4245;
      --chip: #22242a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Arial, sans-serif;
      line-height: 1.5;
      color: var(--text);
      background:
        radial-gradient(circle at 8% -20%, #1d1f24 0%, transparent 45%),
        radial-gradient(circle at 90% -30%, #17191d 0%, transparent 40%),
        var(--bg);
      scroll-behavior: smooth;
    }

    .wrap {
      max-inline-size: 1460px;
      margin-inline: auto;
      padding: 28px 20px 72px;
      display: grid;
      gap: 16px;
    }

    .hero {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: linear-gradient(140deg, #1f2126, #141518 55%);
      box-shadow: 0 22px 44px rgba(0, 0, 0, .35);
      padding: 22px;
      display: grid;
      gap: 14px;
    }

    .hero-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: clamp(24px, 3vw, 34px);
      letter-spacing: .3px;
    }

    p {
      margin: 0;
      color: var(--muted);
    }

    .chip {
      border: 1px solid #33363d;
      border-radius: 999px;
      background: var(--chip);
      color: #dbdee1;
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
    }

    .input, .btn {
      border: 1px solid var(--line);
      border-radius: 12px;
      font: inherit;
      color: var(--text);
      background: #111216;
      padding: 11px 13px;
    }

    .btn {
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(180deg, #2a2d33, #1f2126);
      transition: transform .14s ease, filter .14s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.08);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px;
    }

    .stat {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      padding: 14px;
      display: grid;
      gap: 6px;
    }

    .stat .k { color: var(--muted); font-size: 13px; }
    .stat .v { font-size: 25px; font-weight: 700; }

    .layout {
      display: grid;
      grid-template-columns: 390px 1fr;
      gap: 14px;
      align-items: start;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--bg-soft);
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .guide {
      border-style: dashed;
      background: linear-gradient(180deg, #17191d, #141518);
    }

    .guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }

    .guide-step {
      border: 1px solid #34373e;
      border-radius: 12px;
      padding: 12px;
      background: #16181c;
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .card h2 {
      margin: 0;
      color: var(--accent);
      font-size: 16px;
    }

    .tester {
      display: grid;
      gap: 10px;
    }

    .tester-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    .quick {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-content: flex-start;
    }

    .result {
      border: 1px dashed #34373e;
      border-radius: 10px;
      background: #15171b;
      padding: 12px;
      font-size: 12px;
      min-block-size: 78px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .routes {
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .tag-summary {
      border: 1px solid #34373e;
      border-radius: 10px;
      padding: 8px;
      background: #17191d;
      display: grid;
      gap: 6px;
      font-size: 12px;
    }

    .route {
      border: 1px solid #34373e;
      border-radius: 10px;
      padding: 10px;
      background: #17191d;
    }

    .family {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .family-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .family-list {
      display: grid;
      gap: 10px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .providers {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 12px;
    }

    .provider {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .provider h3 {
      margin: 0;
      font-size: 15px;
      color: var(--accent);
    }

    .map {
      display: grid;
      gap: 6px;
      padding-inline-end: 4px;
      font-size: 12px;
    }

    .map-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      border-block-end: 1px dashed #34373e;
      padding-block-end: 5px;
    }

    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .danger { color: var(--danger); }
    .muted { color: var(--muted); }

    @media (max-inline-size: 990px) {
      .toolbar { grid-template-columns: 1fr; }
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <div class="hero-top">
        <div>
          <h1>Phawse API Studio</h1>
          <p>Modern dashboard for routes, category families, aliases, and provider mappings.</p>
        </div>
        <span class="chip">Strict Family Matching</span>
      </div>
      <div class="toolbar">
        <input class="input" id="search" placeholder="Filter tags/providers/routes (ex: comfy, fluff, tail, anal, yaoi)" />
        <button class="btn" id="reload">Reload Data</button>
        <button class="btn" id="testPinch">Test /gif/pinch</button>
      </div>
    </section>

    <section class="card guide">
      <h2>How To Use This Dashboard</h2>
      <div class="guide-grid">
        <article class="guide-step">
          <strong>1) Start With Core Routes</strong>
          <span class="muted">Use <b>/gif/{tag}</b> for SFW, <b>/nsfw/{tag}</b> for NSFW, <b>/resolve?category=...</b> to see canonical mapping, and <b>/sources</b> to inspect provider capabilities.</span>
        </article>
        <article class="guide-step">
          <strong>2) Test Live Endpoints</strong>
          <span class="muted">Use Quick Tester with examples like <b>/gif/comfy</b>, <b>/gif/kitsune</b>, <b>/nsfw/anal</b>, <b>/nsfw/yaoi</b>. Response preview shows status, latency, source, and source tag.</span>
        </article>
        <article class="guide-step">
          <strong>3) Understand Tag Routing</strong>
          <span class="muted">Categories normalize to canonical families first. Then each provider maps canonical tags to its own source tags (for example canonical <b>solomale</b> -> source <b>solo_male</b>).</span>
        </article>
        <article class="guide-step">
          <strong>4) Read Provider Coverage</strong>
          <span class="muted">Provider cards show two things: <b>Supported source tags</b> and <b>Canonical → source mapping</b>. If a tag is missing in both, that provider will not serve that route.</span>
        </article>
      </div>
    </section>

    <section class="stats" id="stats"></section>

    <section class="layout">
      <aside class="card">
        <h2>Quick Tester</h2>
        <div class="tester">
          <div class="tester-row">
            <input class="input" id="endpointInput" value="/gif/pinch" />
            <button class="btn" id="runTest">Run</button>
          </div>
          <div class="quick">
            <button class="btn" data-q="/gif/pinch">pinch</button>
            <button class="btn" data-q="/gif/shoot">shoot</button>
            <button class="btn" data-q="/gif/lurk">lurk</button>
            <button class="btn" data-q="/gif/disgust">disgust</button>
            <button class="btn" data-q="/gif/comfy">comfy</button>
            <button class="btn" data-q="/gif/fluff">fluff</button>
            <button class="btn" data-q="/gif/tail">tail</button>
            <button class="btn" data-q="/gif/lay">lay</button>
            <button class="btn" data-q="/nsfw/suck">nsfw/suck</button>
            <button class="btn" data-q="/nsfw/anal">nsfw/anal</button>
            <button class="btn" data-q="/nsfw/fuck">nsfw/fuck</button>
            <button class="btn" data-q="/nsfw/solo">nsfw/solo</button>
            <button class="btn" data-q="/nsfw/solomale">nsfw/solomale</button>
            <button class="btn" data-q="/nsfw/pussylick">nsfw/pussylick</button>
            <button class="btn" data-q="/nsfw/yaoi">nsfw/yaoi</button>
            <button class="btn" data-q="/nsfw/yuri">nsfw/yuri</button>
          </div>
          <div class="result" id="testResult">Run a test to inspect live endpoint status + response.</div>
        </div>

        <h2 style="margin-block-start: 6px;">Routes</h2>
        <div class="routes" id="routes"></div>

        <h2 style="margin-block-start: 6px;">All Active Tags</h2>
        <div class="tag-summary" id="tagSummary"></div>
      </aside>

      <section class="card">
        <h2>Category Families & Aliases</h2>
        <div class="family-list" id="families"></div>
      </section>
    </section>

    <section class="card">
      <h2>SFW Provider Mappings</h2>
      <div class="providers" id="sfwProviders"></div>
    </section>

    <section class="card">
      <h2>NSFW Provider Mappings</h2>
      <div class="providers" id="nsfwProviders"></div>
    </section>
  </main>

  <script>
    const state = { schema: null, sources: null, filter: '' };

    const searchInput = document.getElementById('search');
    const reloadBtn = document.getElementById('reload');
    const testPinchBtn = document.getElementById('testPinch');
    const endpointInput = document.getElementById('endpointInput');
    const runTestBtn = document.getElementById('runTest');
    const testResult = document.getElementById('testResult');

    function uniqueSorted(values) {
      return [...new Set((values || []).filter(Boolean))].sort((a, b) => String(a).localeCompare(String(b)));
    }

    function match(text) {
      if (!state.filter) return true;
      return String(text || '').toLowerCase().includes(state.filter);
    }

    function setResult(text, tone = 'muted') {
      testResult.className = `result ${tone}`;
      testResult.textContent = text;
    }

    async function runEndpointTest(path) {
      const target = path.startsWith('/') ? path : `/${path}`;
      setResult(`Testing ${target} ...`, 'warn');
      try {
        const start = performance.now();
        const res = await fetch(target, { cache: 'no-store' });
        const ms = Math.round(performance.now() - start);
        const body = await res.json().catch(() => ({}));
        const preview = JSON.stringify(body).slice(0, 360);
        setResult(`status=${res.status} | ${ms}ms\n${preview}`, res.ok ? 'ok' : 'danger');
      } catch (error) {
        setResult(`Request failed: ${error.message}`, 'danger');
      }
    }

    function renderStats() {
      const routes = Object.keys(state.schema?.routes || {});
      const families = state.schema?.families || {};
      const aliasCount = Object.values(families).reduce((sum, aliases) => sum + aliases.length, 0);
      const sfwCount = Object.keys(state.sources?.sfw || {}).length;
      const nsfwCount = Object.keys(state.sources?.nsfw || {}).length;
      const sfwTags = uniqueSorted(
        Object.values(state.sources?.sfw || {}).flatMap(cfg => [
          ...(cfg?.supportedTags || []),
          ...Object.keys(cfg?.canonicalToSource || {})
        ])
      );
      const nsfwTags = uniqueSorted(
        Object.values(state.sources?.nsfw || {}).flatMap(cfg => [
          ...(cfg?.supportedTags || []),
          ...Object.keys(cfg?.canonicalToSource || {})
        ])
      );

      const blocks = [
        ['Routes', routes.length, 'Public API routes'],
        ['Families', Object.keys(families).length, 'Canonical groups'],
        ['Aliases', aliasCount, 'Total aliases'],
        ['Providers', sfwCount + nsfwCount, `${sfwCount} SFW / ${nsfwCount} NSFW`],
        ['SFW Tags', sfwTags.length, 'Unique mapped + supported'],
        ['NSFW Tags', nsfwTags.length, 'Unique mapped + supported']
      ];

      document.getElementById('stats').innerHTML = blocks
        .map(([k, v, s]) => `<article class="stat"><span class="k">${k}</span><span class="v">${v}</span><span class="muted">${s}</span></article>`)
        .join('');
    }

    function renderRoutes() {
      const entries = Object.entries(state.schema?.routes || {})
        .filter(([route, desc]) => match(`${route} ${desc}`));

      document.getElementById('routes').innerHTML = entries.length
        ? entries.map(([route, desc]) => `<div class="route"><strong>${route}</strong><div class="muted">${desc}</div></div>`).join('')
        : '<div class="muted">No route matches.</div>';
    }

    function renderTagSummary() {
      const sfw = Object.values(state.sources?.sfw || {});
      const nsfw = Object.values(state.sources?.nsfw || {});

      const sfwTags = uniqueSorted(sfw.flatMap(cfg => [
        ...(cfg?.supportedTags || []),
        ...Object.keys(cfg?.canonicalToSource || {})
      ])).filter(tag => match(`sfw ${tag}`));

      const nsfwTags = uniqueSorted(nsfw.flatMap(cfg => [
        ...(cfg?.supportedTags || []),
        ...Object.keys(cfg?.canonicalToSource || {})
      ])).filter(tag => match(`nsfw ${tag}`));

      document.getElementById('tagSummary').innerHTML = `
        <div><strong>SFW</strong> <span class="muted">(${sfwTags.length})</span></div>
        <div class="chips">${sfwTags.map(tag => `<span class="chip">${tag}</span>`).join('') || '<span class="muted">No SFW tags match.</span>'}</div>
        <div><strong>NSFW</strong> <span class="muted">(${nsfwTags.length})</span></div>
        <div class="chips">${nsfwTags.map(tag => `<span class="chip">${tag}</span>`).join('') || '<span class="muted">No NSFW tags match.</span>'}</div>
      `;
    }

    function renderFamilies() {
      const families = state.schema?.families || {};
      const html = Object.entries(families)
        .filter(([name, aliases]) => match(name) || aliases.some(alias => match(alias)))
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([name, aliases]) => `
          <article class="family">
            <div class="family-head">
              <strong>${name}</strong>
              <span class="chip">${aliases.length} alias(es)</span>
            </div>
            <div class="chips">${aliases.map(alias => `<span class="chip">${alias}</span>`).join('')}</div>
          </article>
        `)
        .join('');

      document.getElementById('families').innerHTML = html || '<div class="muted">No family matches filter.</div>';
    }

    function providerCard(name, config) {
      const supported = uniqueSorted(config?.supportedTags || []);
      const supportedVisible = supported.filter(tag => match(`${name} ${tag}`));
      const rows = Object.entries(config?.canonicalToSource || {})
        .filter(([from, to]) => match(`${name} ${from} ${to}`))
        .sort((a, b) => a[0].localeCompare(b[0]));

      if (!rows.length && !supportedVisible.length) return '';

      return `
        <article class="provider">
          <h3>${name}</h3>
          <div class="muted">Alias tags: ${config?.supportsAliasTags ? 'enabled' : 'disabled'}</div>
          <div class="muted">Supported source tags (${supported.length})</div>
          <div class="chips">${supportedVisible.map(tag => `<span class="chip">${tag}</span>`).join('') || '<span class="muted">No supported tags match.</span>'}</div>
          <div class="muted">Canonical tag → provider source tag (${Object.keys(config?.canonicalToSource || {}).length})</div>
          <div class="map">
            ${rows.map(([from, to]) => `<div class="map-item"><span>${from}</span><span class="ok">${to}</span></div>`).join('') || '<div class="muted">No mappings match.</div>'}
          </div>
        </article>
      `;
    }

    function renderProviders() {
      const sfw = Object.entries(state.sources?.sfw || {})
        .map(([name, cfg]) => providerCard(name, cfg))
        .filter(Boolean)
        .join('');

      const nsfw = Object.entries(state.sources?.nsfw || {})
        .map(([name, cfg]) => providerCard(name, cfg))
        .filter(Boolean)
        .join('');

      document.getElementById('sfwProviders').innerHTML = sfw || '<div class="muted">No SFW provider matches filter.</div>';
      document.getElementById('nsfwProviders').innerHTML = nsfw || '<div class="muted">No NSFW provider matches filter.</div>';
    }

    function render() {
      renderStats();
      renderRoutes();
      renderTagSummary();
      renderFamilies();
      renderProviders();
    }

    async function loadData() {
      try {
        const [schemaRes, sourcesRes] = await Promise.all([
          fetch('/schema', { cache: 'no-store' }),
          fetch('/sources', { cache: 'no-store' })
        ]);

        const [schema, sources] = await Promise.all([
          schemaRes.json(),
          sourcesRes.json()
        ]);

        state.schema = schema;
        state.sources = sources;
        render();
      } catch (error) {
        document.getElementById('stats').innerHTML = `<article class="stat"><span class="k danger">Failed to load</span><span class="muted">${error.message}</span></article>`;
      }
    }

    searchInput.addEventListener('input', (e) => {
      state.filter = String(e.target.value || '').trim().toLowerCase();
      render();
    });

    reloadBtn.addEventListener('click', loadData);
    runTestBtn.addEventListener('click', () => runEndpointTest(endpointInput.value));
    testPinchBtn.addEventListener('click', () => runEndpointTest('/gif/pinch'));

    document.querySelectorAll('[data-q]').forEach(btn => {
      btn.addEventListener('click', () => {
        endpointInput.value = btn.getAttribute('data-q');
        runEndpointTest(endpointInput.value);
      });
    });

    loadData();
  </script>
</body>
</html>
