<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Phawse API Explorer</title>
	<style>
		:root {
			--bg: #0b1020;
			--bg-soft: #121933;
			--panel: #172042;
			--text: #eaf0ff;
			--text-soft: #a8b3d6;
			--accent: #8ea2ff;
			--chip: #222c55;
			--ok: #3bcf86;
			--border: #2c3867;
		}

		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: Inter, Segoe UI, Arial, sans-serif;
			background: radial-gradient(circle at top, #15214a 0%, var(--bg) 45%);
			color: var(--text);
		}

		.wrap {
			max-inline-size: 1200px;
			margin: 0 auto;
			padding: 28px 16px 56px;
		}

		.hero {
			background: linear-gradient(135deg, #1d2a57, #111936);
			border: 1px solid var(--border);
			border-radius: 16px;
			padding: 22px;
			box-shadow: 0 12px 30px rgba(0,0,0,.25);
			margin-block-end: 18px;
		}

		h1 { margin: 0 0 8px; font-size: 28px; }
		p { margin: 0; color: var(--text-soft); }

		.toolbar {
			margin-block-start: 14px;
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 10px;
		}

		input {
			inline-size: 100%;
			border: 1px solid var(--border);
			background: #101733;
			color: var(--text);
			border-radius: 10px;
			padding: 10px 12px;
			outline: none;
		}

		button {
			border: 1px solid var(--border);
			background: #1a2550;
			color: var(--text);
			border-radius: 10px;
			padding: 10px 14px;
			cursor: pointer;
		}

		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
			gap: 12px;
			margin-block-start: 14px;
		}

		.card {
			background: var(--panel);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 14px;
		}

		.card h3 {
			margin: 0 0 8px;
			font-size: 15px;
			color: var(--accent);
			letter-spacing: .2px;
		}

		.value {
			font-size: 22px;
			font-weight: 700;
		}

		.section {
			margin-block-start: 16px;
			background: var(--bg-soft);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 14px;
		}

		.section h2 {
			margin: 0 0 10px;
			font-size: 18px;
		}

		.chips {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
		}

		.chip {
			background: var(--chip);
			border: 1px solid #34407a;
			border-radius: 999px;
			padding: 6px 10px;
			font-size: 12px;
			color: #d7e0ff;
		}

		.family {
			margin-block-start: 12px;
			border: 1px solid var(--border);
			border-radius: 12px;
			padding: 12px;
			background: #121b3c;
		}

		.family-head {
			display: flex;
			justify-content: space-between;
			gap: 8px;
			align-items: center;
			margin-block-end: 8px;
		}

		.family-head strong { font-size: 15px; }
		.count { color: var(--text-soft); font-size: 12px; }

		.providers {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 10px;
		}

		.provider {
			border: 1px solid var(--border);
			background: #121b3c;
			border-radius: 12px;
			padding: 12px;
		}

		.provider h4 {
			margin: 0 0 8px;
			color: var(--accent);
		}

		.map-list {
			display: grid;
			gap: 4px;
			max-block-size: 220px;
			overflow: auto;
			padding-inline-end: 4px;
			font-size: 12px;
		}

		.map-item {
			display: flex;
			justify-content: space-between;
			border-block-end: 1px dashed #2c376a;
			padding-block-end: 3px;
		}

		.ok { color: var(--ok); }
		.muted { color: var(--text-soft); }
		.empty {
			padding: 14px;
			border: 1px dashed var(--border);
			border-radius: 12px;
			color: var(--text-soft);
			text-align: center;
		}
	</style>
</head>
<body>
	<main class="wrap">
		<section class="hero">
			<h1>Phawse API Explorer</h1>
			<p>Browse all routes, category families, aliases, and provider tag mappings.</p>
			<div class="toolbar">
				<input id="search" placeholder="Filter tags/families/providers (ex: disgust, shoot, nsfw)" />
				<button id="reload">Reload</button>
			</div>
		</section>

		<section class="grid" id="stats"></section>

		<section class="section">
			<h2>Routes</h2>
			<div class="chips" id="routes"></div>
		</section>

		<section class="section">
			<h2>Category Families & Aliases</h2>
			<div id="families"></div>
		</section>

		<section class="section">
			<h2>SFW Provider Mappings</h2>
			<div class="providers" id="sfwProviders"></div>
		</section>

		<section class="section">
			<h2>NSFW Provider Mappings</h2>
			<div class="providers" id="nsfwProviders"></div>
		</section>
	</main>

	<script>
		const state = {
			schema: null,
			sources: null,
			filter: ''
		};

		const searchInput = document.getElementById('search');
		const reloadBtn = document.getElementById('reload');

		searchInput.addEventListener('input', e => {
			state.filter = (e.target.value || '').trim().toLowerCase();
			render();
		});

		reloadBtn.addEventListener('click', loadData);

		function matchesFilter(text) {
			if (!state.filter) return true;
			return String(text).toLowerCase().includes(state.filter);
		}

		function card(title, value, subtitle = '') {
			return `<article class="card"><h3>${title}</h3><div class="value">${value}</div><p class="muted">${subtitle}</p></article>`;
		}

		function renderStats() {
			const routesCount = Object.keys(state.schema?.routes || {}).length;
			const families = state.schema?.families || {};
			const familyCount = Object.keys(families).length;
			const aliasCount = Object.values(families).reduce((sum, arr) => sum + arr.length, 0);
			const sfwCount = Object.keys(state.sources?.sfw || {}).length;
			const nsfwCount = Object.keys(state.sources?.nsfw || {}).length;

			document.getElementById('stats').innerHTML = [
				card('Routes', routesCount, 'Public internal endpoints'),
				card('Families', familyCount, 'Canonical categories'),
				card('Aliases', aliasCount, 'Total tag aliases'),
				card('Providers', sfwCount + nsfwCount, `${sfwCount} SFW / ${nsfwCount} NSFW`)
			].join('');
		}

		function renderRoutes() {
			const routes = state.schema?.routes || {};
			const html = Object.entries(routes)
				.filter(([route, desc]) => matchesFilter(`${route} ${desc}`))
				.map(([route, desc]) => `<span class="chip"><strong>${route}</strong> â€” ${desc}</span>`)
				.join('');
			document.getElementById('routes').innerHTML = html || '<div class="empty">No route matches filter.</div>';
		}

		function renderFamilies() {
			const families = state.schema?.families || {};
			const blocks = Object.entries(families)
				.filter(([name, aliases]) => {
					if (matchesFilter(name)) return true;
					return aliases.some(alias => matchesFilter(alias));
				})
				.sort((a, b) => a[0].localeCompare(b[0]))
				.map(([name, aliases]) => `
					<article class="family">
						<div class="family-head">
							<strong>${name}</strong>
							<span class="count">${aliases.length} alias(es)</span>
						</div>
						<div class="chips">
							${aliases.map(alias => `<span class="chip">${alias}</span>`).join('')}
						</div>
					</article>
				`)
				.join('');

			document.getElementById('families').innerHTML = blocks || '<div class="empty">No family matches filter.</div>';
		}

		function providerCard(name, config) {
			const map = config?.canonicalToSource || {};
			const rows = Object.entries(map)
				.filter(([from, to]) => matchesFilter(`${name} ${from} ${to}`))
				.sort((a, b) => a[0].localeCompare(b[0]))
				.map(([from, to]) => `<div class="map-item"><span>${from}</span><span class="ok">${to}</span></div>`)
				.join('');

			if (!rows) return '';

			return `
				<article class="provider">
					<h4>${name}</h4>
					<p class="muted">Alias tags: ${config?.supportsAliasTags ? 'enabled' : 'disabled'}</p>
					<div class="map-list">${rows}</div>
				</article>
			`;
		}

		function renderProviders() {
			const sfw = state.sources?.sfw || {};
			const nsfw = state.sources?.nsfw || {};

			const sfwHtml = Object.entries(sfw)
				.map(([name, cfg]) => providerCard(name, cfg))
				.filter(Boolean)
				.join('');

			const nsfwHtml = Object.entries(nsfw)
				.map(([name, cfg]) => providerCard(name, cfg))
				.filter(Boolean)
				.join('');

			document.getElementById('sfwProviders').innerHTML = sfwHtml || '<div class="empty">No SFW provider matches filter.</div>';
			document.getElementById('nsfwProviders').innerHTML = nsfwHtml || '<div class="empty">No NSFW provider matches filter.</div>';
		}

		function render() {
			renderStats();
			renderRoutes();
			renderFamilies();
			renderProviders();
		}

		async function loadData() {
			try {
				const [schemaRes, sourcesRes] = await Promise.all([
					fetch('/schema', { cache: 'no-store' }),
					fetch('/sources', { cache: 'no-store' })
				]);

				const [schema, sources] = await Promise.all([
					schemaRes.json(),
					sourcesRes.json()
				]);

				state.schema = schema;
				state.sources = sources;
				render();
			} catch (error) {
				document.getElementById('stats').innerHTML = '<div class="empty">Failed to load API schema/sources.</div>';
			}
		}

		loadData();
	</script>
</body>
</html>
