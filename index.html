<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phawse API Control Panel</title>
  <style>
    :root {
      --bg: #070b18;
      --bg-soft: #101832;
      --panel: #121d3d;
      --panel-2: #172552;
      --text: #ecf2ff;
      --muted: #a6b3d8;
      --line: #2a3869;
      --primary: #8fa8ff;
      --ok: #45d68e;
      --warn: #ffd166;
      --danger: #ff6b8a;
      --chip: #253567;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% -20%, #1a2b60 0%, var(--bg) 55%);
    }

    .wrap {
      max-inline-size: 1300px;
      margin-inline: auto;
      padding: 24px 16px 64px;
      display: grid;
      gap: 14px;
    }

    .hero {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: linear-gradient(135deg, #1b2b5f, #101834);
      box-shadow: 0 24px 44px rgba(0, 0, 0, .35);
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: clamp(24px, 3vw, 32px);
      letter-spacing: .3px;
    }

    p { margin: 0; color: var(--muted); }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
    }

    .input, .btn {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font: inherit;
      color: var(--text);
      background: #0d1530;
    }

    .btn {
      cursor: pointer;
      background: linear-gradient(180deg, #233770, #1a2b5b);
      font-weight: 600;
      transition: transform .15s ease, filter .15s ease;
    }

    .btn:hover { transform: translateY(-1px); filter: brightness(1.08); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .stat {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--panel);
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .stat .k { color: var(--muted); font-size: 13px; }
    .stat .v { font-size: 24px; font-weight: 700; }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      align-items: start;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--bg-soft);
      padding: 12px;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
      color: var(--primary);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border: 1px solid #3a4e8f;
      border-radius: 999px;
      background: var(--chip);
      color: #dae4ff;
      padding: 6px 10px;
      font-size: 12px;
    }

    .family {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      padding: 10px;
      margin-block-start: 10px;
      display: grid;
      gap: 8px;
    }

    .family-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .family-head strong { font-size: 15px; }

    .providers {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 10px;
    }

    .provider {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--panel);
      padding: 10px;
    }

    .provider h3 {
      margin: 0 0 8px;
      color: var(--primary);
      font-size: 15px;
    }

    .map {
      max-block-size: 210px;
      overflow: auto;
      display: grid;
      gap: 4px;
      padding-inline-end: 4px;
    }

    .map-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      border-block-end: 1px dashed #33457e;
      padding-block-end: 3px;
      font-size: 12px;
    }

    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .danger { color: var(--danger); }
    .muted { color: var(--muted); }

    .tester {
      display: grid;
      gap: 8px;
    }

    .tester-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    .result {
      border: 1px dashed #3a4a85;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      word-break: break-word;
      background: #0f1734;
      min-block-size: 78px;
    }

    .route-list {
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .route-item {
      border: 1px solid #33457e;
      border-radius: 10px;
      padding: 8px;
      background: #111a38;
    }

    @media (max-inline-size: 980px) {
      .layout { grid-template-columns: 1fr; }
      .toolbar { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <div class="title-row">
        <div>
          <h1>Phawse API Control Panel</h1>
          <p>Live explorer for routes, tags, provider mappings, and quick endpoint tests.</p>
        </div>
        <span class="chip">Strict Family Matching</span>
      </div>

      <div class="toolbar">
        <input class="input" id="search" placeholder="Filter families/providers/routes (ex: pinch, shoot, nsfw, otakugif)" />
        <button class="btn" id="reload">Reload Data</button>
        <button class="btn" id="testPinch">Test /gif/pinch</button>
      </div>
    </section>

    <section class="grid" id="stats"></section>

    <section class="layout">
      <aside class="card">
        <h2>Quick Tester</h2>
        <div class="tester">
          <div class="tester-row">
            <input class="input" id="endpointInput" value="/gif/pinch" />
            <button class="btn" id="runTest">Run</button>
          </div>
          <div class="chips">
            <button class="btn" data-q="/gif/pinch">pinch</button>
            <button class="btn" data-q="/gif/shoot">shoot</button>
            <button class="btn" data-q="/gif/disgust">disgust</button>
            <button class="btn" data-q="/nsfw/suck">nsfw/suck</button>
          </div>
          <div class="result" id="testResult">Run a test to see status and response preview.</div>
        </div>

        <h2 style="margin-block-start:12px;">Routes</h2>
        <div class="route-list" id="routes"></div>
      </aside>

      <section class="card">
        <h2>Category Families & Aliases</h2>
        <div id="families"></div>
      </section>
    </section>

    <section class="card">
      <h2>SFW Provider Mappings</h2>
      <div class="providers" id="sfwProviders"></div>
    </section>

    <section class="card">
      <h2>NSFW Provider Mappings</h2>
      <div class="providers" id="nsfwProviders"></div>
    </section>
  </main>

  <script>
    const state = { schema: null, sources: null, filter: '' };

    const searchInput = document.getElementById('search');
    const reloadBtn = document.getElementById('reload');
    const runTestBtn = document.getElementById('runTest');
    const testPinchBtn = document.getElementById('testPinch');
    const endpointInput = document.getElementById('endpointInput');
    const testResult = document.getElementById('testResult');

    function match(text) {
      if (!state.filter) return true;
      return String(text || '').toLowerCase().includes(state.filter);
    }

    function setTestResult(text, tone = 'muted') {
      testResult.className = `result ${tone}`;
      testResult.textContent = text;
    }

    async function runEndpointTest(path) {
      const safePath = path.startsWith('/') ? path : `/${path}`;
      setTestResult(`Testing ${safePath} ...`, 'warn');
      try {
        const started = performance.now();
        const res = await fetch(safePath, { cache: 'no-store' });
        const ms = Math.round(performance.now() - started);
        const body = await res.json().catch(() => ({}));
        const preview = JSON.stringify(body).slice(0, 320);
        const tone = res.ok ? 'ok' : 'danger';
        setTestResult(`status=${res.status} | ${ms}ms\n${preview}`, tone);
      } catch (error) {
        setTestResult(`Request failed: ${error.message}`, 'danger');
      }
    }

    function renderStats() {
      const routes = Object.keys(state.schema?.routes || {});
      const families = state.schema?.families || {};
      const aliases = Object.values(families).reduce((acc, arr) => acc + arr.length, 0);
      const sfw = Object.keys(state.sources?.sfw || {}).length;
      const nsfw = Object.keys(state.sources?.nsfw || {}).length;

      const blocks = [
        ['Routes', routes.length, 'Public API routes'],
        ['Families', Object.keys(families).length, 'Canonical tag groups'],
        ['Aliases', aliases, 'Total alias tags'],
        ['Providers', sfw + nsfw, `${sfw} SFW / ${nsfw} NSFW`]
      ];

      document.getElementById('stats').innerHTML = blocks
        .map(([k, v, s]) => `<article class="stat"><span class="k">${k}</span><span class="v">${v}</span><span class="muted">${s}</span></article>`)
        .join('');
    }

    function renderRoutes() {
      const entries = Object.entries(state.schema?.routes || {})
        .filter(([route, desc]) => match(`${route} ${desc}`));

      document.getElementById('routes').innerHTML = entries.length
        ? entries.map(([route, desc]) => `<div class="route-item"><strong>${route}</strong><div class="muted">${desc}</div></div>`).join('')
        : '<div class="muted">No route matches.</div>';
    }

    function renderFamilies() {
      const families = state.schema?.families || {};
      const html = Object.entries(families)
        .filter(([name, aliases]) => match(name) || aliases.some(alias => match(alias)))
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([name, aliases]) => `
          <article class="family">
            <div class="family-head">
              <strong>${name}</strong>
              <span class="chip">${aliases.length} alias(es)</span>
            </div>
            <div class="chips">${aliases.map(a => `<span class="chip">${a}</span>`).join('')}</div>
          </article>
        `)
        .join('');

      document.getElementById('families').innerHTML = html || '<div class="muted">No family matches filter.</div>';
    }

    function providerCard(providerName, config) {
      const rows = Object.entries(config?.canonicalToSource || {})
        .filter(([from, to]) => match(`${providerName} ${from} ${to}`))
        .sort((a, b) => a[0].localeCompare(b[0]));

      if (!rows.length) return '';

      return `
        <article class="provider">
          <h3>${providerName}</h3>
          <div class="muted">Alias tags: ${config?.supportsAliasTags ? 'enabled' : 'disabled'}</div>
          <div class="map">${rows.map(([from, to]) => `<div class="map-item"><span>${from}</span><span class="ok">${to}</span></div>`).join('')}</div>
        </article>
      `;
    }

    function renderProviders() {
      const sfw = Object.entries(state.sources?.sfw || {}).map(([n, c]) => providerCard(n, c)).filter(Boolean).join('');
      const nsfw = Object.entries(state.sources?.nsfw || {}).map(([n, c]) => providerCard(n, c)).filter(Boolean).join('');

      document.getElementById('sfwProviders').innerHTML = sfw || '<div class="muted">No SFW provider matches filter.</div>';
      document.getElementById('nsfwProviders').innerHTML = nsfw || '<div class="muted">No NSFW provider matches filter.</div>';
    }

    function renderAll() {
      renderStats();
      renderRoutes();
      renderFamilies();
      renderProviders();
    }

    async function loadData() {
      try {
        const [schemaRes, sourcesRes] = await Promise.all([
          fetch('/schema', { cache: 'no-store' }),
          fetch('/sources', { cache: 'no-store' })
        ]);

        const [schema, sources] = await Promise.all([schemaRes.json(), sourcesRes.json()]);
        state.schema = schema;
        state.sources = sources;
        renderAll();
      } catch (error) {
        document.getElementById('stats').innerHTML = `<article class="stat"><span class="k danger">Failed to load</span><span class="muted">${error.message}</span></article>`;
      }
    }

    searchInput.addEventListener('input', e => {
      state.filter = String(e.target.value || '').trim().toLowerCase();
      renderAll();
    });

    reloadBtn.addEventListener('click', loadData);
    runTestBtn.addEventListener('click', () => runEndpointTest(endpointInput.value));
    testPinchBtn.addEventListener('click', () => runEndpointTest('/gif/pinch'));

    document.querySelectorAll('[data-q]').forEach(btn => {
      btn.addEventListener('click', () => {
        endpointInput.value = btn.getAttribute('data-q');
        runEndpointTest(endpointInput.value);
      });
    });

    loadData();
  </script>
</body>
</html>
